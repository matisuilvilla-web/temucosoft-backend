{% extends 'base.html' %}
{% block content %}
<h2 class="text-danger">Panel Super Admin: Empresas</h2>
<div class="row">
    <div class="col-md-4">
        <div class="card p-3 border-danger">
            <h5>Registrar Cliente (Tenant)</h5>
            <form id="compForm" onsubmit="createCompany(event)">
                <div class="mb-2">
                    <label>Nombre Empresa</label>
                    <input type="text" id="cName" class="form-control" required>
                </div>
                <div class="mb-2">
                    <label>RUT Empresa</label>
                    <input type="text" id="cRut" class="form-control" required oninput="this.value = this.value.replace(/[^0-9kK-]/g, '')">
                </div>
                <div class="mb-3">
                    <label>Dirección</label>
                    <input type="text" id="cAddress" class="form-control" required>
                </div>
                <button class="btn btn-danger w-100">Registrar Empresa</button>
            </form>
        </div>
    </div>
    <div class="col-md-8">  
        <div class="card p-3">
            <table class="table" id="compTable">
                <thead><tr><th>ID</th><th>Nombre</th><th>RUT</th><th>Acciones</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Suscripción -->
<div class="modal fade" id="subModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Asignar Plan</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <input type="hidden" id="subCompId">
                <label>Plan</label>
                <select id="subPlan" class="form-select mb-3">
                    <option value="BASIC">Básico</option>
                    <option value="STANDARD">Estándar</option>
                    <option value="PREMIUM">Premium</option>
                </select>
                <label>Fecha Inicio</label>
                <input type="date" id="subStart" class="form-control mb-2">
                <label>Fecha Fin</label>
                <input type="date" id="subEnd" class="form-control mb-3">
                <button onclick="saveSub()" class="btn btn-primary w-100">Guardar Suscripción</button>
            </div>
        </div>
    </div>
</div>

<script>
    async function loadCompanies() {
        const res = await apiFetch('/api/companies/');
        if (res.ok) {
            const data = await res.json();
            const tbody = document.querySelector('#compTable tbody');
            tbody.innerHTML = '';
            data.forEach(c => {
                tbody.innerHTML += `
                    <tr>
                        <td>${c.id}</td>
                        <td>${c.name}</td>
                        <td>${c.rut}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="openSubModal(${c.id})">Plan</button>
                        </td>
                    </tr>`;
            });
        }
    }

    async function createCompany(e) {
        e.preventDefault();
        const payload = {
            name: document.getElementById('cName').value,
            rut: document.getElementById('cRut').value,
            address: document.getElementById('cAddress').value
        };
        const res = await apiFetch('/api/companies/', { method: 'POST', body: JSON.stringify(payload) });
        if(res.ok) {
            alert("Empresa creada");
            loadCompanies();
            document.getElementById('compForm').reset();
        } else {
            alert("Error al crear");
        }
    }

    function openSubModal(id) {
        document.getElementById('subCompId').value = id;
        new bootstrap.Modal(document.getElementById('subModal')).show();
    }

    async function saveSub() {
        const id = document.getElementById('subCompId').value;
        const payload = {
            plan_name: document.getElementById('subPlan').value,
            start_date: document.getElementById('subStart').value,
            end_date: document.getElementById('subEnd').value
        };
        const res = await apiFetch(`/api/companies/${id}/subscribe/`, { method: 'POST', body: JSON.stringify(payload) });
        if(res.ok) {
            alert("Plan asignado correctamente");
            bootstrap.Modal.getInstance(document.getElementById('subModal')).hide();
        } else {
            alert("Error al asignar plan");
        }
    }

    loadCompanies();
</script>
{% endblock %}