{% extends 'base.html' %}
{% block content %}
<h2>Gestión de Proveedores</h2>
<div class="row">
    <!-- Formulario Crear -->
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header">Nuevo Proveedor</div>
            <div class="card-body">
                <form id="supplierForm" onsubmit="createSupplier(event)">
                    <div class="mb-2">
                        <label>Nombre</label>
                        <input type="text" id="supName" class="form-control" required>
                    </div>
                    <div class="mb-2">
                        <label>RUT (Ej: 76111222-3)</label>
                        <input type="text" id="supRut" class="form-control" placeholder="12345678-9" oninput="this.value = this.value.replace(/[^0-9kK-]/g, '')" required>
                        <!-- Feedback ahora viene del backend -->
                    </div>
                    <div class="mb-2">
                        <label>Email Contacto</label>
                        <input type="email" id="supEmail" class="form-control" required>
                    </div>
                    <div class="mb-2">
                        <label>Teléfono</label>
                        <input type="text" id="supPhone" class="form-control"oninput="this.value = this.value.replace(/[^0-9+]/g, '')" required>
                    </div>
                    <button type="submit" class="btn btn-success w-100">Guardar</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Listado -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <table class="table" id="supTable">
                    <thead><tr><th>Nombre</th><th>RUT</th><th>Email</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    async function loadSuppliers() {
        const res = await apiFetch('/api/suppliers/');
        if (res.ok) {
            const data = await res.json();
            const tbody = document.querySelector('#supTable tbody');
            tbody.innerHTML = '';
            data.forEach(s => {
                tbody.innerHTML += `<tr><td>${s.name}</td><td>${s.rut}</td><td>${s.contact_email}</td></tr>`;
            });
        }
    }

    async function createSupplier(e) {
        e.preventDefault();
        
        // REESTRUCTURADO: Ya no validamos RUT aquí. Se envía crudo al backend.
        const payload = {
            name: document.getElementById('supName').value,
            rut: document.getElementById('supRut').value,
            contact_email: document.getElementById('supEmail').value,
            phone: document.getElementById('supPhone').value,
        };

        const res = await apiFetch('/api/suppliers/', {
            method: 'POST',
            body: JSON.stringify(payload)
        });

        if (res.ok) {
            document.getElementById('supplierForm').reset();
            loadSuppliers();
            alert("Proveedor creado exitosamente.");
        } else {
            // Manejo de error del Serializer (Backend)
            const errorData = await res.json();
            // Mostramos el mensaje exacto que envió el backend (ej: "RUT inválido")
            alert("Error del servidor:\n" + JSON.stringify(errorData, null, 2));
        }
    }

    loadSuppliers();
</script>
{% endblock %}